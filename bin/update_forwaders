#! /bin/sh

if test "${user_list}"; then exit 0; fi


function do_update_list()
{
	user_list="$1"; shift
	pfx="$1"; shift
	hostname="$1"; shift
	dest="$1"; shift
	bind_conf="$1"; shift

	if test "${user_list}"
		then
			echo "${bind_conf} { ${user_list}; };" > /run/named/etc/${dest}
			return
		fi

	boot_name_servers=${SIMPLE_BOOT_NAME_SERVERS:-8.8.8.8 8.8.4.4 1.1.1.1 1.0.0.1}

	tmp=$(mktemp -d /run/tmp/update_forwaders_XXXXXX)
	cd ${tmp}

	for ip in ${boot_name_servers}
		do
			dig +short @${ip} ${hostname} > ${ip} &
		done
	wait

	cat * | sort -u > /run/${pfx}.new
	cd /run; rm -rf ${tmp}

	if ! cmp -s /run/${pfx}.new /run/${pfx}.now
		then
			awk 'BEGIN { printf "'"${bind_conf}"' { " }
				{ printf "%s; ",$0 }
				END { print "};" }' /run/${pfx}.new > /run/named/etc/${dest}
			mv /run/${pfx}.new /run/${pfx}.now
			chown named: /run/named/etc/${dest}
			touch /run/need_reconfig
		else
			rm -f /run/${pfx}.new
		fi
}

rm -f /run/need_reconfig
do_update_list "${SIMPLE_RESOLVERS_LIST}" "fwd" "${SIMPLE_RESOLVERS_HOST:-recs.hogshake.net}" "forwarders.inc" "forwarders"
do_update_list "${SIMPLE_AUTH_LIST}" "auth" "${SIMPLE_AUTH_HOST:-auth.hogshake.net}" "authers.inc" "server-addresses"
